name: NFL Data Automation - Workflows Unificados

on:
  schedule:
    # Martes y Jueves 5:00 AM CDMX (11:00 UTC) - Set current week
    - cron: '0 11 * * 2,4'
    # Todos los dÃ­as 11:59 PM CDMX (5:59 UTC del dÃ­a siguiente) - Daily update
    - cron: '59 5 * * *'
    # Todos los dÃ­as 5:00 AM CDMX (11:00 UTC) - Update weekly odds
    - cron: '0 11 * * *'
    # Lunes 17:30 CDMX (23:30 UTC) - Auto-assign weekly picks
    - cron: '30 23 * * 1'

  # Permite ejecutar manualmente
  workflow_dispatch:
    inputs:
      task:
        description: 'Tarea a ejecutar'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - set-current-week
          - daily-update
          - update-weekly-odds
          - auto-update-picks
          - auto-assign-picks
          - save-weekly-records
      force_execution:
        description: 'Forzar ejecuciÃ³n auto-assign (ignora validaciÃ³n de horario)'
        required: false
        default: false
        type: boolean

jobs:
  set-current-week:
    name: Actualizar Semana NFL
    runs-on: ubuntu-latest
    if: |
      github.event.schedule == '0 11 * * 2,4' || 
      (github.event_name == 'workflow_dispatch' && 
       (github.event.inputs.task == 'set-current-week' || github.event.inputs.task == 'all'))
    
    steps:
      - name: ğŸ“… Actualizar semana actual
        run: |
          echo "ğŸ”„ Actualizando semana actual NFL..."
          
          response=$(curl -s -w "\n%{http_code}" -X POST \
            "https://${{ secrets.VERCEL_DOMAIN }}/api/set-current-week" \
            --max-time 30)
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)
          
          echo "ğŸ“¡ HTTP Status: $http_code"
          echo "ğŸ“„ Response: $body"
          
          if [ "$http_code" = "200" ]; then
            echo "âœ… Semana actualizada exitosamente"
          else
            echo "âŒ Error actualizando semana"
            exit 1
          fi

  daily-update:
    name: ActualizaciÃ³n Diaria de Partidos
    runs-on: ubuntu-latest
    if: |
      github.event.schedule == '59 5 * * *' || 
      (github.event_name == 'workflow_dispatch' && 
       (github.event.inputs.task == 'daily-update' || github.event.inputs.task == 'all'))
    
    outputs:
      update-success: ${{ steps.update-matches.outputs.success }}
    
    steps:
      - name: ğŸˆ Actualizar partidos diariamente
        id: update-matches
        run: |
          echo "ğŸ”„ Ejecutando actualizaciÃ³n diaria de partidos..."
          
          response=$(curl -s -w "\n%{http_code}" -X POST \
            "https://${{ secrets.VERCEL_DOMAIN }}/api/update-matches" \
            --max-time 60)
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)
          
          echo "ğŸ“¡ HTTP Status: $http_code"
          echo "ğŸ“„ Response: $body"
          
          if [ "$http_code" = "200" ]; then
            echo "âœ… Partidos actualizados exitosamente"
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Error actualizando partidos"
            echo "success=false" >> $GITHUB_OUTPUT
            exit 1
          fi

  auto-update-picks:
    name: Auto-Update de Picks (DespuÃ©s de Update Matches)
    runs-on: ubuntu-latest
    needs: daily-update
    if: |
      (needs.daily-update.result == 'success' && needs.daily-update.outputs.update-success == 'true') ||
      (github.event_name == 'workflow_dispatch' && 
       (github.event.inputs.task == 'auto-update-picks' || github.event.inputs.task == 'all'))
    
    steps:
      - name: ğŸ¯ Actualizar picks segÃºn resultados
        run: |
          echo "ğŸ”„ Ejecutando auto-update de picks..."
          echo "â„¹ï¸  Este endpoint solo actualiza picks de partidos completados"
          
          response=$(curl -s -w "\n%{http_code}" -X POST \
            "https://${{ secrets.VERCEL_DOMAIN }}/api/auto-update-picks" \
            --max-time 60)
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)
          
          echo "ğŸ“¡ HTTP Status: $http_code"
          echo "ğŸ“„ Response: $body"
          
          if [ "$http_code" = "200" ]; then
            echo "âœ… Picks actualizados exitosamente"
            
            # Extraer informaciÃ³n del resultado
            picks_updated=$(echo "$body" | jq -r '.picks_updated // 0' 2>/dev/null || echo "0")
            entries_updated=$(echo "$body" | jq -r '.entries_updated // 0' 2>/dev/null || echo "0")
            
            echo "ğŸ¯ Picks actualizados: $picks_updated"
            echo "ğŸ‘¥ Entradas actualizadas: $entries_updated"
          else
            echo "âŒ Error actualizando picks"
            exit 1
          fi

  update-weekly-odds:
    name: Actualizar Momios Semanales
    runs-on: ubuntu-latest
    if: |
      github.event.schedule == '0 11 * * *' || 
      (github.event_name == 'workflow_dispatch' && 
       (github.event.inputs.task == 'update-weekly-odds' || github.event.inputs.task == 'all'))
    
    steps:
      - name: ğŸ“Š Actualizar momios semanales
        run: |
          echo "ğŸ”„ Actualizando momios semanales..."
          
          response=$(curl -s -w "\n%{http_code}" -X POST \
            "https://${{ secrets.VERCEL_DOMAIN }}/api/update-weekly-odds-auto" \
            --max-time 45)
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)
          
          echo "ğŸ“¡ HTTP Status: $http_code"
          echo "ğŸ“„ Response: $body"
          
          if [ "$http_code" = "200" ]; then
            echo "âœ… Momios actualizados exitosamente"
          else
            echo "âŒ Error actualizando momios"
            exit 1
          fi

  save-weekly-records:
    name: Guardar Records Semanales
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' && 
      (github.event.inputs.task == 'save-weekly-records' || github.event.inputs.task == 'all')
    
    steps:
      - name: ğŸ“Š Obtener informaciÃ³n de temporada
        id: season-info
        run: |
          echo "ğŸ” Obteniendo informaciÃ³n de la temporada actual..."
          
          season_info=$(curl -s "https://${{ secrets.VERCEL_DOMAIN }}/api/current-week" --max-time 30)
          
          if [ $? -eq 0 ]; then
            year=$(echo "$season_info" | jq -r '.year // 2024' 2>/dev/null || echo "2024")
            week=$(echo "$season_info" | jq -r '.week // 1' 2>/dev/null || echo "1")
            
            # Calcular semana anterior para guardar records
            week_to_save=$((week - 1))
            if [ $week_to_save -lt 1 ]; then
              week_to_save=1
            fi
            
            echo "year=$year" >> $GITHUB_OUTPUT
            echo "week_to_save=$week_to_save" >> $GITHUB_OUTPUT
            
            echo "ğŸ“… AÃ±o: $year"
            echo "ğŸ“Š Semana a guardar: $week_to_save"
          else
            echo "âŒ Error obteniendo informaciÃ³n de temporada"
            echo "year=2024" >> $GITHUB_OUTPUT
            echo "week_to_save=1" >> $GITHUB_OUTPUT
          fi
      
      - name: ğŸ’¾ Guardar records semanales
        run: |
          echo "ğŸ”„ Guardando records semanales..."
          
          year="${{ steps.season-info.outputs.year }}"
          week_to_save="${{ steps.season-info.outputs.week_to_save }}"
          
          response=$(curl -s -w "\n%{http_code}" -X POST \
            "https://${{ secrets.VERCEL_DOMAIN }}/api/save-weekly-team-records?year=$year&week=$week_to_save" \
            --max-time 45)
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)
          
          echo "ğŸ“¡ HTTP Status: $http_code"
          echo "ğŸ“„ Response: $body"
          
          if [ "$http_code" = "200" ]; then
            echo "âœ… Records guardados exitosamente"
          else
            echo "âŒ Error guardando records"
            exit 1
          fi

  auto-assign-picks:
    name: Auto-Assign Picks Semanal
    runs-on: ubuntu-latest
    if: |
      github.event.schedule == '30 23 * * 1' || 
      (github.event_name == 'workflow_dispatch' && 
       (github.event.inputs.task == 'auto-assign-picks' || github.event.inputs.task == 'all'))
    
    steps:
      - name: ğŸ“… Log inicio
        run: |
          echo "ğŸš€ AUTO-ASSIGN SEMANAL DE PICKS"
          echo "ğŸ“… Fecha: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "ğŸ¯ Workflow: ${{ github.run_id }}"
      
      - name: ğŸ“Š Consultar programaciÃ³n
        id: check-schedule
        run: |
          echo "ğŸ” Consultando programaciÃ³n del auto-assign..."
          
          response=$(curl -s -w "\n%{http_code}" -X GET \
            "https://${{ secrets.VERCEL_DOMAIN }}/api/schedule-weekly-auto-assign" \
            --max-time 30)
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)
          
          echo "ğŸ“¡ HTTP Status: $http_code"
          echo "ğŸ“„ Response: $body"
          
          should_execute="false"
          
          if [ "$http_code" = "200" ]; then
            should_execute_now=$(echo "$body" | jq -r '.execution_schedule.should_execute_now // false' 2>/dev/null || echo "false")
            minutes_until=$(echo "$body" | jq -r '.execution_schedule.minutes_until_execution // 999' 2>/dev/null || echo "999")
            execution_time=$(echo "$body" | jq -r '.execution_schedule.execution_time_cdmx // "unknown"' 2>/dev/null || echo "unknown")
            current_week=$(echo "$body" | jq -r '.current_week // 0' 2>/dev/null || echo "0")
            last_match_kickoff=$(echo "$body" | jq -r '.last_match.kickoff_cdmx // "unknown"' 2>/dev/null || echo "unknown")
            
            echo "â° Tiempo programado: $execution_time"
            echo "ğŸˆ Ãšltimo partido: $last_match_kickoff"
            echo "ğŸ“… Semana: $current_week"
            echo "â³ Minutos restantes: $minutes_until"
            echo "âœ… Â¿Debe ejecutarse ahora?: $should_execute_now"
            
            # LÃ³gica para determinar ejecuciÃ³n
            if [ "${{ github.event.inputs.force_execution }}" = "true" ]; then
              should_execute="true"
              echo "ğŸš€ EjecuciÃ³n forzada por parÃ¡metro manual"
            elif [ "$should_execute_now" = "true" ]; then
              should_execute="true"
              echo "âœ… Es momento de ejecutar segÃºn programaciÃ³n"
            elif [ "$minutes_until" != "999" ] && [ "$minutes_until" -le 30 ] && [ "$minutes_until" -ge -30 ]; then
              should_execute="true"
              echo "âš¡ Dentro de ventana de 30 minutos, ejecutando"
            else
              echo "â¸ï¸ No es momento de ejecutar. Esperando a $execution_time"
            fi
          else
            echo "âŒ Error consultando programaciÃ³n"
            echo "ğŸ¤” Ejecutando de todas formas por ser lunes"
            should_execute="true"
          fi
          
          echo "should_execute=$should_execute" >> $GITHUB_OUTPUT
      
      - name: ğŸ¯ Ejecutar auto-assign
        if: steps.check-schedule.outputs.should_execute == 'true'
        run: |
          echo "ğŸš€ EJECUTANDO AUTO-ASSIGN DE PICKS"
          
          # Ejecutar con reintentos
          max_retries=3
          retry_count=0
          success=false
          
          while [ $retry_count -lt $max_retries ] && [ "$success" = "false" ]; do
            echo "ğŸ”„ Intento $((retry_count + 1))/$max_retries..."
            
            response=$(curl -s -w "\n%{http_code}" -X POST \
              "https://${{ secrets.VERCEL_DOMAIN }}/api/auto-assign-last-game-picks" \
              --max-time 60)
            
            http_code=$(echo "$response" | tail -n1)
            body=$(echo "$response" | head -n-1)
            
            echo "ğŸ“¡ HTTP Status: $http_code"
            echo "ğŸ“„ Response: $body"
            
            if [ "$http_code" = "200" ]; then
              success=true
              echo "âœ… Auto-assign completado exitosamente"
              
              # Extraer informaciÃ³n del resultado
              picks_assigned=$(echo "$body" | jq -r '.picks_assigned // 0' 2>/dev/null || echo "0")
              total_entries=$(echo "$body" | jq -r '.total_entries_without_picks // 0' 2>/dev/null || echo "0")
              week=$(echo "$body" | jq -r '.week // 0' 2>/dev/null || echo "0")
              
              echo "ğŸ“Š Resultado exitoso:"
              echo "ğŸ¯ Picks asignados: $picks_assigned"
              echo "ğŸ“‹ Total de entradas: $total_entries"
              echo "ğŸ“… Semana: $week"
            else
              retry_count=$((retry_count + 1))
              if [ $retry_count -lt $max_retries ]; then
                echo "âš ï¸ Intento fallido, reintentando en 20 segundos..."
                sleep 20
              fi
            fi
          done
          
          if [ "$success" = "false" ]; then
            echo "âŒ Error: No se pudo completar auto-assign despuÃ©s de $max_retries intentos"
            exit 1
          fi
      
      - name: ğŸ”„ Auto-update picks (post-procesamiento)
        if: steps.check-schedule.outputs.should_execute == 'true'
        run: |
          echo "â³ Esperando 30 segundos antes de auto-update..."
          sleep 30
          
          echo "ğŸ”„ Ejecutando auto-update-picks..."
          
          response=$(curl -s -w "\n%{http_code}" -X POST \
            "https://${{ secrets.VERCEL_DOMAIN }}/api/auto-update-picks" \
            --max-time 45)
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)
          
          echo "ğŸ“¡ Auto-update Status: $http_code"
          echo "ğŸ“„ Response: $body"
          
          if [ "$http_code" = "200" ]; then
            echo "âœ… Auto-update completado exitosamente"
          else
            echo "âš ï¸ Auto-update retornÃ³ status: $http_code (no crÃ­tico)"
          fi
      
      - name: ğŸ“‹ Resumen final
        if: always()
        run: |
          echo "ğŸ“‹ RESUMEN DE AUTO-ASSIGN SEMANAL"
          echo "================================="
          echo "ğŸ†” Workflow: ${{ github.run_id }}"
          echo "ğŸ“… Fecha: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "ğŸ¯ Forzado: ${{ github.event.inputs.force_execution || 'false' }}"
          echo "âš¡ Ejecutado: ${{ steps.check-schedule.outputs.should_execute }}"
          echo ""
          echo "ğŸ”— Detalles: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
