name: NFL Data Automation - Workflows Unificados

on:
  schedule:
    # Martes y Jueves 5:00 AM CDMX (11:00 UTC) - Set current week
    - cron: '0 11 * * 2,4'
    # Todos los dÃ­as 11:59 PM CDMX (5:59 UTC del dÃ­a siguiente) - Daily update
    - cron: '59 5 * * *'
    # Todos los dÃ­as 5:00 AM CDMX (11:00 UTC) - Update weekly odds
    - cron: '0 11 * * *'
    # Lunes 17:00 CDMX (23:00 UTC) - Auto-assign picks
    - cron: '0 23 * * 1'

  # Permite ejecutar manualmente
  workflow_dispatch:
    inputs:
      task:
        description: 'Tarea a ejecutar'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - set-current-week
          - daily-update
          - update-weekly-odds
          - auto-assign-picks
          - save-weekly-records

jobs:
  set-current-week:
    name: Actualizar Semana NFL
    runs-on: ubuntu-latest
    if: |
      github.event.schedule == '0 11 * * 2,4' || 
      (github.event_name == 'workflow_dispatch' && 
       (github.event.inputs.task == 'set-current-week' || github.event.inputs.task == 'all'))
    
    steps:
      - name: ğŸ“… Actualizar semana actual
        run: |
          echo "ğŸ”„ Actualizando semana actual NFL..."
          
          response=$(curl -s -w "\n%{http_code}" -X POST \
            "https://${{ secrets.VERCEL_DOMAIN }}/api/set-current-week" \
            --max-time 30)
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)
          
          echo "ğŸ“¡ HTTP Status: $http_code"
          echo "ğŸ“„ Response: $body"
          
          if [ "$http_code" = "200" ]; then
            echo "âœ… Semana actualizada exitosamente"
          else
            echo "âŒ Error actualizando semana"
            exit 1
          fi

  daily-update:
    name: ActualizaciÃ³n Diaria de Partidos
    runs-on: ubuntu-latest
    if: |
      github.event.schedule == '59 5 * * *' || 
      (github.event_name == 'workflow_dispatch' && 
       (github.event.inputs.task == 'daily-update' || github.event.inputs.task == 'all'))
    
    steps:
      - name: ğŸˆ Actualizar partidos diariamente
        run: |
          echo "ğŸ”„ Ejecutando actualizaciÃ³n diaria de partidos..."
          
          response=$(curl -s -w "\n%{http_code}" -X POST \
            "https://${{ secrets.VERCEL_DOMAIN }}/api/update-matches" \
            --max-time 60)
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)
          
          echo "ğŸ“¡ HTTP Status: $http_code"
          echo "ğŸ“„ Response: $body"
          
          if [ "$http_code" = "200" ]; then
            echo "âœ… Partidos actualizados exitosamente"
          else
            echo "âŒ Error actualizando partidos"
            exit 1
          fi

  update-weekly-odds:
    name: Actualizar Momios Semanales
    runs-on: ubuntu-latest
    if: |
      github.event.schedule == '0 11 * * *' || 
      (github.event_name == 'workflow_dispatch' && 
       (github.event.inputs.task == 'update-weekly-odds' || github.event.inputs.task == 'all'))
    
    steps:
      - name: ğŸ“Š Actualizar momios semanales
        run: |
          echo "ğŸ”„ Actualizando momios semanales..."
          
          response=$(curl -s -w "\n%{http_code}" -X POST \
            "https://${{ secrets.VERCEL_DOMAIN }}/api/update-weekly-odds-auto" \
            --max-time 45)
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)
          
          echo "ğŸ“¡ HTTP Status: $http_code"
          echo "ğŸ“„ Response: $body"
          
          if [ "$http_code" = "200" ]; then
            echo "âœ… Momios actualizados exitosamente"
          else
            echo "âŒ Error actualizando momios"
            exit 1
          fi

  auto-assign-picks:
    name: Auto-Assign de Picks
    runs-on: ubuntu-latest
    if: |
      github.event.schedule == '0 23 * * 1' || 
      (github.event_name == 'workflow_dispatch' && 
       (github.event.inputs.task == 'auto-assign-picks' || github.event.inputs.task == 'all'))
    
    steps:
      - name: ğŸ¯ Ejecutar auto-assign de picks
        run: |
          echo "ğŸ”„ Ejecutando auto-assign de picks..."
          
          response=$(curl -s -w "\n%{http_code}" -X POST \
            "https://${{ secrets.VERCEL_DOMAIN }}/api/auto-assign-last-game-picks" \
            --max-time 60)
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)
          
          echo "ğŸ“¡ HTTP Status: $http_code"
          echo "ğŸ“„ Response: $body"
          
          if [ "$http_code" = "200" ]; then
            echo "âœ… Auto-assign completado exitosamente"
            
            # Extraer informaciÃ³n del resultado
            picks_assigned=$(echo "$body" | jq -r '.picks_assigned // 0' 2>/dev/null || echo "0")
            total_entries=$(echo "$body" | jq -r '.total_entries_without_picks // 0' 2>/dev/null || echo "0")
            
            echo "ğŸ¯ Picks asignados: $picks_assigned de $total_entries entradas"
          else
            echo "âŒ Error en auto-assign"
            exit 1
          fi

  save-weekly-records:
    name: Guardar Records Semanales
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' && 
      (github.event.inputs.task == 'save-weekly-records' || github.event.inputs.task == 'all')
    
    steps:
      - name: ğŸ“Š Obtener informaciÃ³n de temporada
        id: season-info
        run: |
          echo "ğŸ” Obteniendo informaciÃ³n de la temporada actual..."
          
          season_info=$(curl -s "https://${{ secrets.VERCEL_DOMAIN }}/api/current-week" --max-time 30)
          
          if [ $? -eq 0 ]; then
            year=$(echo "$season_info" | jq -r '.year // 2024' 2>/dev/null || echo "2024")
            week=$(echo "$season_info" | jq -r '.week // 1' 2>/dev/null || echo "1")
            
            # Calcular semana anterior para guardar records
            week_to_save=$((week - 1))
            if [ $week_to_save -lt 1 ]; then
              week_to_save=1
            fi
            
            echo "year=$year" >> $GITHUB_OUTPUT
            echo "week_to_save=$week_to_save" >> $GITHUB_OUTPUT
            
            echo "ğŸ“… AÃ±o: $year"
            echo "ğŸ“Š Semana a guardar: $week_to_save"
          else
            echo "âŒ Error obteniendo informaciÃ³n de temporada"
            echo "year=2024" >> $GITHUB_OUTPUT
            echo "week_to_save=1" >> $GITHUB_OUTPUT
          fi
      
      - name: ğŸ’¾ Guardar records semanales
        run: |
          echo "ğŸ”„ Guardando records semanales..."
          
          year="${{ steps.season-info.outputs.year }}"
          week_to_save="${{ steps.season-info.outputs.week_to_save }}"
          
          response=$(curl -s -w "\n%{http_code}" -X POST \
            "https://${{ secrets.VERCEL_DOMAIN }}/api/save-weekly-team-records?year=$year&week=$week_to_save" \
            --max-time 45)
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)
          
          echo "ğŸ“¡ HTTP Status: $http_code"
          echo "ğŸ“„ Response: $body"
          
          if [ "$http_code" = "200" ]; then
            echo "âœ… Records guardados exitosamente"
          else
            echo "âŒ Error guardando records"
            exit 1
          fi