name: NFL Data Automation - Cron Jobs

on:
  schedule:
    # Set current week: Martes y Jueves a las 5:00 AM CDMX (11:00 AM UTC)
    - cron: '0 11 * * 2,4'
    # Daily update: Todos los d√≠as a las 11:59 PM CDMX (5:59 AM UTC del d√≠a siguiente)
    - cron: '59 5 * * *'
    # Update weekly odds: Todos los d√≠as a las 5:00 AM CDMX (11:00 AM UTC)
    - cron: '0 11 * * *'
  

  # Permite ejecutar manualmente desde GitHub
  workflow_dispatch:
    inputs:
      job:
        description: 'Job to run'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - set-current-week
          - daily-update
          - update-weekly-odds
          - save-weekly-team-records

jobs:
  set-current-week:
    name: Update Current NFL Week
    runs-on: ubuntu-latest
    # Solo ejecutar en el cron de martes/jueves o manualmente
    if: github.event.schedule == '0 11 * * 2,4' || github.event_name == 'workflow_dispatch' && (github.event.inputs.job == 'set-current-week' || github.event.inputs.job == 'all')
    steps:
      - name: üìÖ Set Current Week
        run: |
          echo "üîÑ Calling set-current-week endpoint..."
          response=$(curl -s -w "\n%{http_code}" -X POST \
            https://${{ secrets.VERCEL_DOMAIN }}/api/set-current-week)
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)
          echo "HTTP Status: $http_code"
          echo "Response: $body"
          if [ $http_code -eq 200 ]; then
            echo "‚úÖ Current week updated successfully"
          else
            echo "‚ùå Failed to update current week"
            exit 1
          fi

  daily-update:
    name: Daily Matches and Picks Update
    runs-on: ubuntu-latest
    # Solo ejecutar en el cron diario o manualmente
    if: github.event.schedule == '59 5 * * *' || github.event_name == 'workflow_dispatch' && (github.event.inputs.job == 'daily-update' || github.event.inputs.job == 'all')
    steps:
      - name: üèà Daily Update (Matches + Picks)
        run: |
          echo "üîÑ Calling daily-update endpoint..."
          response=$(curl -s -w "\n%{http_code}" -X POST \
            https://${{ secrets.VERCEL_DOMAIN }}/api/daily-update)
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)
          echo "HTTP Status: $http_code"
          echo "Response: $body"
          if [ $http_code -eq 200 ]; then
            echo "‚úÖ Daily update completed successfully"
            echo "$body" | jq '.'
          else
            echo "‚ùå Daily update failed"
            exit 1
          fi

  update-weekly-odds:
    name: Update Weekly Odds
    runs-on: ubuntu-latest
    # Solo ejecutar en el cron de 5 AM o manualmente
    if: github.event.schedule == '0 11 * * *' || github.event_name == 'workflow_dispatch' && (github.event.inputs.job == 'update-weekly-odds' || github.event.inputs.job == 'all')
    steps:
      - name: üé≤ Update Weekly Odds
        run: |
          echo "üîÑ Calling update-weekly-odds-auto endpoint..."
          response=$(curl -s -w "\n%{http_code}" -X POST \
            https://${{ secrets.VERCEL_DOMAIN }}/api/update-weekly-odds-auto)
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)
          echo "HTTP Status: $http_code"
          echo "Response: $body"
          if [ $http_code -eq 200 ]; then
            echo "‚úÖ Weekly odds updated successfully"
            echo "$body" | jq '.'
          else
            echo "‚ùå Failed to update weekly odds"
            exit 1
          fi

  auto-assign-last-game-picks:
    name: Auto Assign Last Game Picks
    runs-on: ubuntu-latest
    # Este job se ejecuta 5 minutos despu√©s de que el √∫ltimo partido empiece (din√°mico)
    # La ejecuci√≥n se controla desde la l√≥gica backend calculando la hora del √∫ltimo partido
    # Para pruebas locales, descomenta esta l√≠nea:
    # if: github.event_name == 'workflow_dispatch'
    steps:
      - name: üéØ Auto Assign Picks to Entries Without Selection
        run: |
          echo "üîÑ Calling auto-assign-last-game-picks endpoint..."
          response=$(curl -s -w "\n%{http_code}" -X POST \
            https://${{ secrets.VERCEL_DOMAIN }}/api/auto-assign-last-game-picks)
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)
          echo "HTTP Status: $http_code"
          echo "Response: $body"
          if [ $http_code -eq 200 ]; then
            echo "‚úÖ Auto-assign picks completed successfully"
            echo "$body" | jq '.'
          else
            echo "‚ùå Auto-assign picks failed"
            exit 1
          fi

  save-weekly-team-records:
    name: Save Weekly Team Records
    runs-on: ubuntu-latest
  # Ejecutar cada martes a las 00:00 AM UTC (despu√©s de la semana NFL)
    if: github.event.schedule == '0 0 * * 2' || github.event_name == 'workflow_dispatch' && (github.event.inputs.job == 'save-weekly-team-records' || github.event.inputs.job == 'all')
    steps:
      - name: üèà Save Weekly Team Records
        run: |
          echo "üîÑ Calling save-weekly-team-records endpoint..."
          YEAR=$(date +'%Y')
          SEASON_INFO=$(curl -s "https://${{ secrets.VERCEL_DOMAIN }}/api/current-week")
          WEEK=$(echo "$SEASON_INFO" | jq -r '.current_week // 1')
          WEEK_TO_SAVE=$((WEEK-1))
          if [ "$WEEK_TO_SAVE" -lt 1 ]; then
            echo "No hay semana anterior para guardar."
            exit 0
          fi
          echo "Guardando r√©cords para a√±o $YEAR, semana $WEEK_TO_SAVE"
          response=$(curl -s -w "\n%{http_code}" -X POST \
            "https://${{ secrets.VERCEL_DOMAIN }}/api/save-weekly-team-records?year=$YEAR&week=$WEEK_TO_SAVE")
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)
          echo "HTTP Status: $http_code"
          echo "Response: $body"
          if [ $http_code -eq 200 ]; then
            echo "‚úÖ Weekly team records saved successfully"
          else
            echo "‚ùå Failed to save weekly team records"
            exit 1
          fi

