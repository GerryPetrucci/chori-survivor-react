name: Auto Assign Weekly Picks - Lunes 17:00 CDMX

# Se ejecuta los lunes a las 17:00 CDMX (23:00 UTC)
on:
  schedule:
    - cron: '0 23 * * 1'  # Lunes 17:00 CDMX

  # Permitir ejecuciÃ³n manual
  workflow_dispatch:
    inputs:
      force_execution:
        description: 'Forzar ejecuciÃ³n inmediata'
        required: false
        default: false
        type: boolean

jobs:
  auto-assign-weekly:
    name: Auto-Assign Picks Semanal
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“… Log inicio
        run: |
          echo "ğŸš€ AUTO-ASSIGN SEMANAL DE PICKS"
          echo "ğŸ“… Fecha: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "ğŸ¯ Workflow: ${{ github.run_id }}"
      
      - name: ğŸ“Š Consultar programaciÃ³n
        id: check-schedule
        run: |
          echo "ğŸ” Consultando programaciÃ³n del auto-assign..."
          
          response=$(curl -s -w "\n%{http_code}" -X GET \
            "https://${{ secrets.VERCEL_DOMAIN }}/api/schedule-weekly-auto-assign" \
            --max-time 30)
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)
          
          echo "ğŸ“¡ HTTP Status: $http_code"
          echo "ğŸ“„ Response: $body"
          
          should_execute="false"
          
          if [ "$http_code" = "200" ]; then
            should_execute_now=$(echo "$body" | jq -r '.execution_schedule.should_execute_now // false' 2>/dev/null || echo "false")
            minutes_until=$(echo "$body" | jq -r '.execution_schedule.minutes_until_execution // 999' 2>/dev/null || echo "999")
            execution_time=$(echo "$body" | jq -r '.execution_schedule.execution_time_cdmx // "unknown"' 2>/dev/null || echo "unknown")
            current_week=$(echo "$body" | jq -r '.current_week // 0' 2>/dev/null || echo "0")
            last_match_kickoff=$(echo "$body" | jq -r '.last_match.kickoff_cdmx // "unknown"' 2>/dev/null || echo "unknown")
            
            echo "â° Tiempo programado: $execution_time"
            echo "ğŸˆ Ãšltimo partido: $last_match_kickoff"
            echo "ğŸ“… Semana: $current_week"
            echo "â³ Minutos restantes: $minutes_until"
            echo "âœ… Â¿Debe ejecutarse ahora?: $should_execute_now"
            
            # LÃ³gica para determinar ejecuciÃ³n
            if [ "${{ github.event.inputs.force_execution }}" = "true" ]; then
              should_execute="true"
              echo "ğŸš€ EjecuciÃ³n forzada por parÃ¡metro manual"
            elif [ "$should_execute_now" = "true" ]; then
              should_execute="true"
              echo "âœ… Es momento de ejecutar segÃºn programaciÃ³n"
            elif [ "$minutes_until" != "999" ] && [ "$minutes_until" -le 30 ] && [ "$minutes_until" -ge -30 ]; then
              should_execute="true"
              echo "âš¡ Dentro de ventana de 30 minutos, ejecutando"
            else
              echo "â¸ï¸ No es momento de ejecutar. Esperando a $execution_time"
            fi
          else
            echo "âŒ Error consultando programaciÃ³n"
            echo "ğŸ¤” Ejecutando de todas formas por ser lunes"
            should_execute="true"
          fi
          
          echo "should_execute=$should_execute" >> $GITHUB_OUTPUT
      
      - name: ğŸ¯ Ejecutar auto-assign
        if: steps.check-schedule.outputs.should_execute == 'true'
        run: |
          echo "ğŸš€ EJECUTANDO AUTO-ASSIGN DE PICKS"
          
          # Ejecutar con reintentos
          max_retries=3
          retry_count=0
          success=false
          
          while [ $retry_count -lt $max_retries ] && [ "$success" = "false" ]; do
            echo "ğŸ”„ Intento $((retry_count + 1))/$max_retries..."
            
            response=$(curl -s -w "\n%{http_code}" -X POST \
              "https://${{ secrets.VERCEL_DOMAIN }}/api/auto-assign-last-game-picks" \
              --max-time 60)
            
            http_code=$(echo "$response" | tail -n1)
            body=$(echo "$response" | head -n-1)
            
            echo "ğŸ“¡ HTTP Status: $http_code"
            echo "ğŸ“„ Response: $body"
            
            if [ "$http_code" = "200" ]; then
              success=true
              echo "âœ… Auto-assign completado exitosamente"
              
              # Extraer informaciÃ³n del resultado
              picks_assigned=$(echo "$body" | jq -r '.picks_assigned // 0' 2>/dev/null || echo "0")
              total_entries=$(echo "$body" | jq -r '.total_entries_without_picks // 0' 2>/dev/null || echo "0")
              week=$(echo "$body" | jq -r '.week // 0' 2>/dev/null || echo "0")
              
              echo "ğŸ“Š Resultado exitoso:"
              echo "ğŸ¯ Picks asignados: $picks_assigned"
              echo "ğŸ“‹ Total de entradas: $total_entries"
              echo "ğŸ“… Semana: $week"
            else
              retry_count=$((retry_count + 1))
              if [ $retry_count -lt $max_retries ]; then
                echo "âš ï¸ Intento fallido, reintentando en 20 segundos..."
                sleep 20
              fi
            fi
          done
          
          if [ "$success" = "false" ]; then
            echo "âŒ Error: No se pudo completar auto-assign despuÃ©s de $max_retries intentos"
            exit 1
          fi
      
      - name: ğŸ”„ Auto-update picks (post-procesamiento)
        if: steps.check-schedule.outputs.should_execute == 'true'
        run: |
          echo "â³ Esperando 30 segundos antes de auto-update..."
          sleep 30
          
          echo "ğŸ”„ Ejecutando auto-update-picks..."
          
          response=$(curl -s -w "\n%{http_code}" -X POST \
            "https://${{ secrets.VERCEL_DOMAIN }}/api/auto-update-picks" \
            --max-time 45)
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)
          
          echo "ğŸ“¡ Auto-update Status: $http_code"
          echo "ğŸ“„ Response: $body"
          
          if [ "$http_code" = "200" ]; then
            echo "âœ… Auto-update completado exitosamente"
          else
            echo "âš ï¸ Auto-update retornÃ³ status: $http_code (no crÃ­tico)"
          fi
      
      - name: ğŸ“‹ Resumen final
        if: always()
        run: |
          echo "ğŸ“‹ RESUMEN DE AUTO-ASSIGN SEMANAL"
          echo "================================="
          echo "ğŸ†” Workflow: ${{ github.run_id }}"
          echo "ğŸ“… Fecha: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "ğŸ¯ Forzado: ${{ github.event.inputs.force_execution || 'false' }}"
          echo "âš¡ Ejecutado: ${{ steps.check-schedule.outputs.should_execute }}"
          echo ""
          echo "ğŸ”— Detalles: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"